name: Create New Secret

on:
  workflow_dispatch:
    inputs:
      logLevel:
        description: 'Log level'
        required: true
        default: 'warning'
        type: choice
        options:
          - info
          - warning
          - debug
      environment:
        description: 'Select Environment'
        required: true
        type: choice
        options:
          - production
          - staging
          - sandbox
      secret_category:
        description: 'Select Secret Category'
        required: true
        type: choice
        options:
          - customer-experience
          - infra
          - lending
      service:
        description: 'Name of the service (secret file name without extension)'
        required: true
      secret_key:
        description: 'Secret key to add or update'
        required: true
      secret_value:
        description: 'Secret value for the key'
        required: true
      sops_version:
        description: 'SOPS configuration version (v1 or v2)'
        required: true
        type: choice
        options:
          - v1
          - v2

jobs:
  modify-secret-file:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      # Import PGP Private Key based on secret_category and capture fingerprint
      - name: Import PGP Private Key and Capture Fingerprint
        run: |
          import_and_extract_fingerprint() {
            KEY="$1"
            PASSPHRASE="$2"
            echo "Importing PGP key..."
            echo "$KEY" | gpg --batch --no-tty --import --pinentry-mode loopback --passphrase "$PASSPHRASE" 2>&1
            gpg_error=$?
            
            if [ $gpg_error -ne 0 ]; then
              echo "Failed to import PGP key, error code: $gpg_error"
              exit $gpg_error
            fi

            echo "Listing imported keys..."
            gpg --list-keys
            gpg --list-secret-keys

            echo "Extracting fingerprint..."
            FINGERPRINT=$(gpg --list-secret-keys --with-colons | grep '^fpr' | head -n 1 | cut -d':' -f10)
            
            if [ -z "$FINGERPRINT" ]; then
              echo "Failed to extract fingerprint"
              exit 1
            fi

            echo "Fingerprint extracted: $FINGERPRINT"
            echo "FINGERPRINT=$FINGERPRINT" >> $GITHUB_ENV
          }

          case "${{ github.event.inputs.secret_category }}" in
            "lending")
              import_and_extract_fingerprint "${{ secrets.LENDING_PGP_PRIVATE_KEY }}" "${{ secrets.LENDING_GPG_PASSPHRASE }}"
              ;;
            "infra")
              import_and_extract_fingerprint "${{ secrets.INFRA_PGP_PRIVATE_KEY }}" "${{ secrets.INFRA_GPG_PASSPHRASE }}"
              ;;
            "customer-experience")
              import_and_extract_fingerprint "${{ secrets.CE_PGP_PRIVATE_KEY }}" "${{ secrets.CE_GPG_PASSPHRASE }}"
              ;;
            *)
              echo "::error ::Invalid secret category."
              exit 1
              ;;
          esac

      - name: Export AGE Key Based on Secret Category
        run: |
          export_age_key() {
            AGE_KEY="$1"
            echo "Exporting AGE key..."
            echo "$AGE_KEY" > age_key.txt
          }

          case "${{ github.event.inputs.secret_category }}" in
            "lending")
              export_age_key "${{ secrets.LENDING_AGE_KEY }}"
              ;;
            "infra")
              export_age_key "${{ secrets.INFRA_AGE_KEY }}"
              ;;
            "customer-experience")
              export_age_key "${{ secrets.CE_AGE_KEY }}"
              ;;
            *)
              echo "::error ::Invalid secret category."
              exit 1
              ;;
          esac

      - name: Install sops
        run: |
          wget https://github.com/mozilla/sops/releases/download/v3.7.1/sops_3.7.1_amd64.deb
          sudo dpkg -i sops_3.7.1_amd64.deb

      - name: Handle Secret Value
        run: |
          SECRET_VALUE=$(jq -r '.inputs.secret_value' $GITHUB_EVENT_PATH)
          echo "::add-mask::$SECRET_VALUE"
          chmod +x scripts/wrapper.sh
          SECRET_TEMP_FILE=$(./scripts/wrapper.sh)
          echo "SECRET_TEMP_FILE=$SECRET_TEMP_FILE" >> $GITHUB_ENV

      - name: Define Secret File Path
        run: |
          echo "SECRET_FILE_PATH=secrets/${{ github.event.inputs.environment }}/${{ github.event.inputs.secret_category }}/${{ github.event.inputs.service }}.yaml" >> $GITHUB_ENV

      - name: Check if Secret File Exists
        run: |
          if [ ! -f "${{ env.SECRET_FILE_PATH }}" ]; then
            echo "::error ::Secret file does not exist or path is incorrect."
            exit 1
          fi

      - name: Decrypt Secret File
        run: |
          sops --config configs/${{ github.event.inputs.sops_version }}_sops.yaml --decrypt ${{ env.SECRET_FILE_PATH }} > decrypted_file.yml

      - name: Update Secret File Using Temporary Secret File
        run: |
          SECRET_VALUE=$(<"$SECRET_TEMP_FILE")
          echo "${{ github.event.inputs.secret_key }}: $SECRET_VALUE" >> decrypted_file.yml

      - name: Re-Encrypt Secret File
        run: |
          sops --encrypt decrypted_file.yml > ${{ env.SECRET_FILE_PATH }}

      - name: Cleanup
        run: |
          gpg --delete-secret-keys --batch --yes ${{ env.FINGERPRINT }}
          rm -f "$SECRET_TEMP_FILE"
          rm -f age_key.txt

      # Additional steps to commit changes, if necessary
